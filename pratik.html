<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Security-Policy" 
      content="
      img-src 'self' data: https://images.unsplash.com;">

  <meta http-equiv="Content-Security-Policy" 
      content="
        default-src 'self'; 
        connect-src 'self' https://mugeh4pkw0.execute-api.eu-north-1.amazonaws.com; 
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
        font-src 'self' https://fonts.gstatic.com; 
        img-src 'self' data:; 
        script-src 'self' 'unsafe-inline';
      ">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tiffin Buddy</title>
  <!-- Use Poppins font for a modern, attractive look -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    /* ---------- GLOBAL STYLES ---------- */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
      /* Full-page background image */
      background: url('background.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #333;
    }
    a { cursor: pointer; text-decoration: none; }
    
    /* ---------- HEADER (Hidden Until Login) ---------- */
    header {
      display: none; /* hidden until user logs in */
      background: rgba(29,30,34,0.9);
      color: #fff;
      text-align: center;
      padding: 20px 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      border-radius: 0 0 10px 10px;
      position: relative;
    }
    header h1 {
      margin: 0;
      font-weight: 700;
      font-size: 24px;
    }
    header nav {
      margin-top: 10px;
    }
    header nav a {
      color: #fff;
      margin: 0 10px;
      padding: 6px 12px;
      border-radius: 4px;
      transition: background 0.3s;
    }
    header nav a:hover {
      background: #3e4147;
    }
    
    /* ---------- SECTIONS ---------- */
    section {
      width: 90%;
      max-width: 900px;
      margin: 30px auto;
      background: rgba(255,255,255,0.97);
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: none;
      position: relative;
    }
    section.active { display: block; }
    section h2 {
      margin-top: 0;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 600;
      color: #1d1e22;
    }
    
    /* ---------- LOGIN SECTION ---------- */
    #login {
      min-height: 80vh;
      display: flex;
      align-items: center;
      justify-content: center;
      /* Outer container remains transparent so the background shows */
      background: transparent;
      position: relative;
      border-radius: 10px;
      overflow: hidden;
    }
    #login::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: url('https://images.unsplash.com/photo-1557682250-45d0f2a4a79d?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80') no-repeat center center;
      background-size: cover;
      filter: blur(6px);
      z-index: -1;
    }
    /* The login card remains as the only white box */
    #loginCard {
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(4px);
      border-radius: 10px;
      padding: 30px 20px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      position: relative;
      z-index: 2;
    }
    
    /* ---------- LOGO & WEBSITE NAME ON LOGIN PAGE ---------- */
    .logo-section {
      text-align: center;
      margin-bottom: 20px;
    }
    .logo-section img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .logo-section h1 {
      margin: 10px 0 0;
      font-size: 28px;
      font-weight: 700;
      color: #1d1e22;
      letter-spacing: 1px;
    }
    
    /* ---------- LOGIN FORM ---------- */
    #loginCard h2 { 
      text-align: center; 
      color: #1d1e22; 
      margin-bottom: 20px; 
    }
    .login-tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      gap: 10px;
    }
    .login-tab {
      padding: 8px 16px;
      cursor: pointer;
      border: 2px solid #1d1e22;
      color: #1d1e22;
      border-radius: 20px;
      font-weight: 500;
      transition: all 0.3s;
    }
    .login-tab.active { background: #1d1e22; color: #fff; }
    
    input, select, textarea, button {
      width: 90%;
      margin: 10px auto;
      display: block;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      transition: all 0.3s;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #1d1e22;
      box-shadow: 0 0 4px rgba(29,30,34,0.5);
    }
    button {
      background: #1d1e22;
      color: #fff;
      font-weight: 500;
      cursor: pointer;
      border: none;
    }
    button:hover {
      background: #3e4147;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }
    
    /* ---------- FORGOT PASSWORD MODAL (OTP) ---------- */
    #forgotModal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    #forgotModal .modal-content {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    #forgotModal h3 {
      margin: 0 0 10px;
      color: #1d1e22;
      font-weight: 600;
    }
    
    /* ---------- PROVIDER CARD (SEARCH RESULTS) ---------- */
    .provider-card {
      background: #fff;
      border-radius: 10px;
      margin: 15px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.07);
      transition: transform 0.3s, box-shadow 0.3s;
      cursor: pointer;
      display: flex;
      align-items: center;
      padding: 15px;
      gap: 15px;
    }
    .provider-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .provider-card img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 50%;
      border: 2px solid #1d1e22;
      flex-shrink: 0;
    }
    .provider-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      text-align: left;
      line-height: 1.4;
    }
    .provider-info strong {
      font-size: 16px;
      margin-bottom: 5px;
      display: inline-block;
    }
    .provider-info p {
      margin: 3px 0;
    }
    .provider-info .price-line {
      margin-top: 5px;
      color: #444;
      font-size: 14px;
      font-weight: 500;
    }
    
    /* ---------- PROVIDER PROFILE ---------- */
    .profile-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
      align-items: center;
    }
    .directions-btn {
      background: linear-gradient(45deg, #4285F4, #357AE8);
      border: none;
      color: #fff;
      font-weight: 600;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .directions-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .whatsapp-btn {
      background: linear-gradient(45deg, #25D366, #128C7E);
      border: none;
      color: #fff;
      font-weight: 600;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .whatsapp-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    /* ---------- WEEKLY MENU ---------- */
    .daily-menu {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 12px;
      margin: 8px auto;
    }
    .daily-menu label {
      font-weight: 500;
      margin-bottom: 6px;
      display: block;
    }
    
    /* ---------- MY PROFILE SECTION (Provider's Own Profile) ---------- */
    #myProfileDetails p {
      margin: 6px 0;
      line-height: 1.4;
    }
    #myProfileDetails p strong { color: #333; }
    .edit-btn {
      background: #555;
      color: #fff;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      margin-top: 10px;
      cursor: pointer;
    }
    .edit-btn:hover { background: #777; }
    .profile-edit-field { display: block; margin: 5px 0; }
    .delete-btn {
      background: #c00;
      color: #fff;
      margin-top: 15px;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      border: none;
    }
    .delete-btn:hover { background: #900; }
  </style>
</head>
<body>
  <!-- FORGOT PASSWORD MODAL -->
  <div id="forgotModal">
    <div class="modal-content">
      <h3>Forgot Password (OTP)</h3>
      <div id="forgotStep1">
        <input type="email" id="forgotEmail" placeholder="Enter your email" />
        <button onclick="sendOTP()">Send OTP</button>
      </div>
      <div id="forgotStep2" style="display:none;">
        <p><strong id="showOTP" style="color:green;"></strong></p>
        <input type="text" id="otpInput" placeholder="Enter OTP" />
        <input type="password" id="newPassword" placeholder="New password" style="margin-top:10px;" />
        <button onclick="verifyOTP()" style="margin-top:15px;">Reset Password</button>
      </div>
      <button onclick="closeForgotModal()" style="margin-top:15px; background:#ccc; color:#333;">Cancel</button>
      <div id="forgotStatus" style="margin-top:10px; color:#e00;"></div>
    </div>
  </div>
  
  <!-- HEADER (hidden until login) -->
  <header id="mainHeader">
    <h1>Tiffin Buddy</h1>
    <nav>
      <a onclick="showSection('home')">Home</a>
      <a id="providerLink" onclick="showSection('dashboard')">Dashboard</a>
      <a id="myProfileLink" onclick="showMyProfile()">My Profile</a>
      <a onclick="logout()">Logout</a>
    </nav>
  </header>
  
  <!-- LOGIN / SIGNUP (Default) -->
  <section id="login" class="active">
    <div id="loginCard">
      <!-- Tiffin Buddy LOGO and Website Name -->
      <div class="logo-section">
        <img src="LOGO.jpg" alt="Tiffin Buddy Logo" />
        <h1>Tiffin Buddy</h1>
      </div>
      <h2>Login / Signup</h2>
      <div class="login-tabs">
        <div id="visitorTab" class="login-tab active" onclick="showVisitorLogin()">Visitor</div>
        <div id="providerTab" class="login-tab" onclick="showProviderLogin()">Provider</div>
      </div>
      
      <!-- Visitor Login Form -->
      <div id="visitorLogin">
        <input type="email" id="visitorEmail" placeholder="Visitor Email"/>
        <input type="password" id="visitorPassword" placeholder="Password"/>
        <div style="text-align:right; margin:0 20px;">
          <a onclick="openForgotModal('visitor')" style="font-size:13px; color:#333;">Forgot Password?</a>
        </div>
        <button onclick="loginVisitor()">Login as Visitor</button>
        <button onclick="signupVisitor()">Signup as Visitor</button>
        <div id="visitorStatus" style="text-align:center; margin-top:10px;"></div>
      </div>
      
      <!-- Provider Login Form (hidden) -->
      <div id="providerLogin" style="display:none;">
        <input type="email" id="providerEmail" placeholder="Provider Email"/>
        <input type="password" id="providerPassword" placeholder="Password"/>
        <div style="text-align:right; margin:0 20px;">
          <a onclick="openForgotModal('provider')" style="font-size:13px; color:#333;">Forgot Password?</a>
        </div>
        <button onclick="loginProvider()">Login as Provider</button>
        <button onclick="signupProvider()">Signup as Provider</button>
        <div id="providerLoginStatus" style="text-align:center; margin-top:10px;"></div>
      </div>
    </div>
  </section>
  
  <!-- HOME PAGE (for Visitors) -->
  <section id="home">
    <h2>Find Your Tiffin Service</h2>
    <input type="text" id="searchInput" placeholder="Search by name or location"/>
    <select id="searchFoodType">
      <option value="all">All</option>
      <option value="veg">Vegetarian</option>
      <option value="non-veg">Non-Vegetarian</option>
      <option value="vegan">Vegan</option>
      <option value="jain">Jain</option>
    </select>
    <button onclick="searchTiffin()">Search</button>
    <div id="searchResults"></div>
  </section>
  
  <!-- PROVIDER DASHBOARD -->
  <section id="dashboard">
    <h2>Provider Dashboard</h2>
    <p style="text-align:center; margin-bottom:10px;">Add or update your Tiffin Service details.</p>
    <input type="text" id="providerName" placeholder="Your Name"/>
    <input type="text" id="providerLocation" placeholder="Location"/>
    <input type="text" id="providerFoodType" placeholder="Food Type (e.g., Veg, Non-Vegetarian)"/>
    <input type="number" id="perTiffinPrice" placeholder="Per Tiffin Price (in ‚Çπ)" />
    <input type="number" id="monthlyPrice" placeholder="Monthly Price (in ‚Çπ)" />
    <textarea id="providerMenu" placeholder="Menu Details" rows="4"></textarea>
    <input type="text" id="openTime" placeholder="Service Open Time (e.g., 8 AM - 8 PM)"/>
    <input type="text" id="contactNumber" placeholder="WhatsApp Number (+91)" />

    <h3 style="margin-top:20px;">Weekly Menu</h3>
    <div class="daily-menu">
      <label>Monday Menu</label>
      <input type="text" id="menuMonday" placeholder="Monday menu"/>
      <input type="file" id="imageMonday" accept="image/*"/>
    </div>
    <div class="daily-menu">
      <label>Tuesday Menu</label>
      <input type="text" id="menuTuesday" placeholder="Tuesday menu"/>
      <input type="file" id="imageTuesday" accept="image/*"/>
    </div>
    <div class="daily-menu">
      <label>Wednesday Menu</label>
      <input type="text" id="menuWednesday" placeholder="Wednesday menu"/>
      <input type="file" id="imageWednesday" accept="image/*"/>
    </div>
    <div class="daily-menu">
      <label>Thursday Menu</label>
      <input type="text" id="menuThursday" placeholder="Thursday menu"/>
      <input type="file" id="imageThursday" accept="image/*"/>
    </div>
    <div class="daily-menu">
      <label>Friday Menu</label>
      <input type="text" id="menuFriday" placeholder="Friday menu"/>
      <input type="file" id="imageFriday" accept="image/*"/>
    </div>
    <div class="daily-menu">
      <label>Saturday Menu</label>
      <input type="text" id="menuSaturday" placeholder="Saturday menu"/>
      <input type="file" id="imageSaturday" accept="image/*"/>
    </div>
    <div class="daily-menu">
      <label>Sunday Menu</label>
      <input type="text" id="menuSunday" placeholder="Sunday menu"/>
      <input type="file" id="imageSunday" accept="image/*"/>
    </div>

    <h3 style="margin-top:20px;">Upload Dish Images (General)</h3>
    <input type="file" id="providerImages" accept="image/*" multiple/>
    <button onclick="addService()">Add/Update Service</button>
    <div id="providerStatus" style="text-align:center; margin-top:10px;"></div>
  </section>
  
  <!-- MY PROFILE (Provider's Own Profile) -->
  <section id="myProfile">
    <h2>My Profile</h2>
    <div id="myProfileDetails"></div>
    <button onclick="backToHome()">Back to Home</button>
  </section>
  
  <!-- PUBLIC PROVIDER PROFILE (for visitors) -->
  <section id="providerProfile">
    <h2>Provider Profile</h2>
    <div id="profileDetails"></div>
    <button onclick="backToHome()">Back to Search</button>
  </section>
  
  <script>
    /* ---------- GLOBALS ---------- */
    let visitors = JSON.parse(localStorage.getItem('visitors') || '[]');   
    let providers = JSON.parse(localStorage.getItem('providers') || '[]'); 
    let currentPublicProfile = null; 
    let currentUserType = '';

    // For OTP
    let forgotUserType = ''; 
    let forgotEmail = '';    
    let forgotOTP = '';      

    // Optional: Use symbols for Veg/Non-Veg
    function getFoodSymbol(foodType) {
      const type = (foodType || '').toLowerCase();
      if (type === 'veg') return 'üå±';
      if (type === 'non-veg') return 'üçó';
      if (type === 'vegan') return 'ü•¶';
      if (type === 'jain') return 'üïâ'; 
      return '';
    }

    // Utility to format +91 number with a space, e.g. +91 9876543210
    function formatIndianNumber(phone) {
      if (!phone) return '';
      let digits = phone.replace(/[^\d+]/g, '');
      if (!digits.startsWith('+91')) {
        if (digits.startsWith('91')) digits = '+' + digits;
        else digits = '+91' + digits;
      }
      const pattern = /^\+91(\d+)/;
      if (pattern.test(digits)) {
        const rest = digits.slice(3);
        return `+91 ${rest}`;
      }
      return digits;
    }

    /* ---------- VALIDATION HELPERS ---------- */
    function isValidEmail(email) {
      // Basic regex to check email format
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }
    function isStrongPassword(password) {
      // Check if password is at least 8 characters long
      return password.length >= 8;
    }

    /* ---------- SHOW/HIDE SECTIONS ---------- */
    function showSection(id) {
      document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function logout() {
      document.getElementById('mainHeader').style.display = 'none';
      showSection('login');
      document.getElementById('login').style.display = 'flex';
    }

    /* ---------- SWITCH LOGIN UI ---------- */
    function showVisitorLogin() {
      document.getElementById('visitorLogin').style.display = 'block';
      document.getElementById('providerLogin').style.display = 'none';
      document.getElementById('visitorTab').classList.add('active');
      document.getElementById('providerTab').classList.remove('active');
    }
    function showProviderLogin() {
      document.getElementById('visitorLogin').style.display = 'none';
      document.getElementById('providerLogin').style.display = 'block';
      document.getElementById('providerTab').classList.add('active');
      document.getElementById('visitorTab').classList.remove('active');
    }

    /* ---------- VISITOR LOGIN/SIGNUP ---------- */
    function signupVisitor() {
      const email = document.getElementById('visitorEmail').value.trim().toLowerCase();
      const password = document.getElementById('visitorPassword').value;
      const statusDiv = document.getElementById('visitorStatus');
      
      if (!isValidEmail(email)) {
        statusDiv.innerHTML = `<p style='color:red;'>Please enter a valid email address.</p>`;
        return;
      }
      if (!isStrongPassword(password)) {
        statusDiv.innerHTML = `<p style='color:red;'>Poor password: set a stronger password (minimum 8 characters).</p>`;
        return;
      }
      if (!email || !password) {
        statusDiv.innerHTML = `<p style='color:red;'>Please enter both email and password.</p>`;
        return;
      }
      const existing = visitors.find(v => v.email === email);
      if (existing) {
        statusDiv.innerHTML = `<p style='color:red;'>Email already registered.</p>`;
        return;
      }
      visitors.push({ email, password });
      localStorage.setItem('visitors', JSON.stringify(visitors));
      statusDiv.innerHTML = `<p style='color:green;'>Visitor signup successful for ${email}</p>`;
      currentUserType = 'visitor';

      document.getElementById('providerLink').style.display = 'none';
      document.getElementById('myProfileLink').style.display = 'none';
      document.getElementById('mainHeader').style.display = 'block';
      document.getElementById('login').style.display = 'none';
      showSection('home');
    }

    function loginVisitor() {
      const email = document.getElementById('visitorEmail').value.trim().toLowerCase();
      const password = document.getElementById('visitorPassword').value;
      const statusDiv = document.getElementById('visitorStatus');
      
      if (!isValidEmail(email)) {
        statusDiv.innerHTML = `<p style='color:red;'>Please enter a valid email address.</p>`;
        return;
      }
      if (!isStrongPassword(password)) {
        statusDiv.innerHTML = `<p style='color:red;'>Password is too weak.</p>`;
        return;
      }
      
      if (!email || !password) {
        statusDiv.innerHTML = `<p style='color:red;'>Please enter both email and password.</p>`;
        return;
      }
      const found = visitors.find(v => v.email === email && v.password === password);
      if (found) {
        statusDiv.innerHTML = `<p style='color:green;'>Visitor logged in as ${email}</p>`;
        currentUserType = 'visitor';

        document.getElementById('providerLink').style.display = 'none';
        document.getElementById('myProfileLink').style.display = 'none';
        document.getElementById('mainHeader').style.display = 'block';
        document.getElementById('login').style.display = 'none';
        showSection('home');
      } else {
        statusDiv.innerHTML = `<p style='color:red;'>Invalid credentials.</p>`;
      }
    }

    /* ---------- PROVIDER LOGIN/SIGNUP ---------- */
    function signupProvider() {
      const email = document.getElementById('providerEmail').value.trim().toLowerCase();
      const password = document.getElementById('providerPassword').value;
      const statusDiv = document.getElementById('providerLoginStatus');
      
      if (!isValidEmail(email)) {
        statusDiv.innerHTML = `<p style='color:red;'>Please enter a valid email address.</p>`;
        return;
      }
      if (!isStrongPassword(password)) {
        statusDiv.innerHTML = `<p style='color:red;'>Poor password: set a stronger password (minimum 8 characters).</p>`;
        return;
      }
      if (!email || !password) {
        statusDiv.innerHTML = `<p style='color:red;'>Please enter both email and password.</p>`;
        return;
      }
      const existing = providers.find(p => p.email === email);
      if (existing) {
        statusDiv.innerHTML = `<p style='color:red;'>Email already registered.</p>`;
        return;
      }
      providers.push({ email, password, details: {} });
      localStorage.setItem('providers', JSON.stringify(providers));
      statusDiv.innerHTML = `<p style='color:green;'>Provider signup successful for ${email}</p>`;
      currentUserType = 'provider';

      document.getElementById('providerLink').style.display = 'inline-block';
      document.getElementById('myProfileLink').style.display = 'inline-block';
      document.getElementById('mainHeader').style.display = 'block';
      document.getElementById('login').style.display = 'none';
      loadProviderDetails(email);
      showSection('dashboard');
    }

    function loginProvider() {
      const email = document.getElementById('providerEmail').value.trim().toLowerCase();
      const password = document.getElementById('providerPassword').value;
      const statusDiv = document.getElementById('providerLoginStatus');
      
      if (!isValidEmail(email)) {
        statusDiv.innerHTML = `<p style='color:red;'>Please enter a valid email address.</p>`;
        return;
      }
      if (!isStrongPassword(password)) {
        statusDiv.innerHTML = `<p style='color:red;'>Password is too weak.</p>`;
        return;
      }
      
      if (!email || !password) {
        statusDiv.innerHTML = `<p style='color:red;'>Please enter both email and password.</p>`;
        return;
      }
      const found = providers.find(p => p.email === email && p.password === password);
      if (found) {
        statusDiv.innerHTML = `<p style='color:green;'>Provider logged in as ${email}</p>`;
        currentUserType = 'provider';

        document.getElementById('providerLink').style.display = 'inline-block';
        document.getElementById('myProfileLink').style.display = 'inline-block';
        document.getElementById('mainHeader').style.display = 'block';
        document.getElementById('login').style.display = 'none';
        localStorage.setItem('provider', JSON.stringify(found));
        loadProviderDetails(email);
        showSection('dashboard');
      } else {
        statusDiv.innerHTML = `<p style='color:red;'>Invalid credentials.</p>`;
      }
    }

    /* ---------- LOAD PROVIDER DASHBOARD DETAILS ---------- */
    function loadProviderDetails(email) {
      if (!email) {
        const stored = JSON.parse(localStorage.getItem('provider') || '{}');
        if (stored.details) fillDashboard(stored.details);
      } else {
        const found = providers.find(p => p.email === email);
        if (found && found.details) fillDashboard(found.details);
      }
    }

    function fillDashboard(d) {
      document.getElementById('providerName').value     = d.name || '';
      document.getElementById('providerLocation').value = d.location || '';
      document.getElementById('providerFoodType').value = d.foodType || '';
      document.getElementById('perTiffinPrice').value   = d.perTiffinPrice || '';
      document.getElementById('monthlyPrice').value     = d.monthlyPrice || '';
      document.getElementById('providerMenu').value     = d.menu || '';
      document.getElementById('openTime').value         = d.openTime || '';

      let phone = d.contactNumber || '';
      phone = formatIndianNumber(phone);
      d.contactNumber = phone;
      document.getElementById('contactNumber').value = phone;

      if (d.weeklyMenu) {
        document.getElementById('menuMonday').value    = d.weeklyMenu.monday?.text || '';
        document.getElementById('menuTuesday').value   = d.weeklyMenu.tuesday?.text || '';
        document.getElementById('menuWednesday').value = d.weeklyMenu.wednesday?.text || '';
        document.getElementById('menuThursday').value  = d.weeklyMenu.thursday?.text || '';
        document.getElementById('menuFriday').value    = d.weeklyMenu.friday?.text || '';
        document.getElementById('menuSaturday').value  = d.weeklyMenu.saturday?.text || '';
        document.getElementById('menuSunday').value    = d.weeklyMenu.sunday?.text || '';
      }
    }

    async function readSingleImage(elementId) {
      const fileInput = document.getElementById(elementId);
      if (fileInput.files && fileInput.files[0]) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = e => resolve(e.target.result);
          reader.onerror = () => reject('Error reading file');
          reader.readAsDataURL(fileInput.files[0]);
        });
      } else {
        return Promise.resolve('');
      }
    }

    async function addService() {
      const name          = document.getElementById('providerName').value.trim();
      const location      = document.getElementById('providerLocation').value.trim();
      const foodType      = document.getElementById('providerFoodType').value.trim().toLowerCase();
      const perTiffin     = document.getElementById('perTiffinPrice').value.trim();
      const monthly       = document.getElementById('monthlyPrice').value.trim();
      const menu          = document.getElementById('providerMenu').value.trim();
      const openTime      = document.getElementById('openTime').value.trim();
      let   contactNumber = document.getElementById('contactNumber').value.trim();
      const statusDiv     = document.getElementById('providerStatus');

      // format phone
      contactNumber = formatIndianNumber(contactNumber);

      if (!name || !location || !foodType || !perTiffin || !monthly || !menu || !openTime || !contactNumber) {
        statusDiv.innerHTML = `<p style='color:red;'>Please fill all required fields (including both price fields).</p>`;
        return;
      }

      const monText = document.getElementById('menuMonday').value.trim();
      const tueText = document.getElementById('menuTuesday').value.trim();
      const wedText = document.getElementById('menuWednesday').value.trim();
      const thuText = document.getElementById('menuThursday').value.trim();
      const friText = document.getElementById('menuFriday').value.trim();
      const satText = document.getElementById('menuSaturday').value.trim();
      const sunText = document.getElementById('menuSunday').value.trim();

      const monImg = await readSingleImage('imageMonday');
      const tueImg = await readSingleImage('imageTuesday');
      const wedImg = await readSingleImage('imageWednesday');
      const thuImg = await readSingleImage('imageThursday');
      const friImg = await readSingleImage('imageFriday');
      const satImg = await readSingleImage('imageSaturday');
      const sunImg = await readSingleImage('imageSunday');

      const weeklyMenu = {
        monday:    { text: monText, image: monImg },
        tuesday:   { text: tueText, image: tueImg },
        wednesday: { text: wedText, image: wedImg },
        thursday:  { text: thuText, image: thuImg },
        friday:    { text: friText, image: friImg },
        saturday:  { text: satText, image: satImg },
        sunday:    { text: sunText, image: sunImg }
      };

      const storedProvider = JSON.parse(localStorage.getItem('provider') || '{}');
      storedProvider.details = {
        name,
        location,
        foodType,
        perTiffinPrice: perTiffin,
        monthlyPrice: monthly,
        menu,
        openTime,
        contactNumber,
        weeklyMenu
      };

      const imageFiles = document.getElementById('providerImages').files;
      let generalImages = [];
      if (imageFiles.length > 0) {
        generalImages = await Promise.all(
          Array.from(imageFiles).map(file => {
            return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = e => resolve(e.target.result);
              reader.onerror = () => reject('Error reading file');
              reader.readAsDataURL(file);
            });
          })
        );
      }
      storedProvider.details.images = generalImages;

      localStorage.setItem('provider', JSON.stringify(storedProvider));
      const foundIndex = providers.findIndex(p => p.email === storedProvider.email);
      if (foundIndex > -1) {
        providers[foundIndex].details = storedProvider.details;
      }
      localStorage.setItem('providers', JSON.stringify(providers));

      statusDiv.innerHTML = `<p style='color:green;'>Service for ${name} updated successfully!</p>`;
    }

    function showMyProfile() {
      const stored = JSON.parse(localStorage.getItem('provider') || '{}');
      const container = document.getElementById('myProfileDetails');
      container.innerHTML = '';
      if (!stored.details) {
        container.innerHTML = `<p>No profile data found. Please update your details in the Dashboard.</p>`;
      } else {
        const d = stored.details;
        container.innerHTML = `
          <p><strong>Name:</strong> ${d.name || ''}</p>
          <p><strong>Location:</strong> ${d.location || ''}</p>
          <p><strong>Food Type:</strong> ${d.foodType || ''}</p>
          <p><strong>Per Tiffin Price:</strong> ‚Çπ${d.perTiffinPrice || ''}</p>
          <p><strong>Monthly Price:</strong> ‚Çπ${d.monthlyPrice || ''}</p>
          <p><strong>Open Time:</strong> ${d.openTime || ''}</p>
          <p><strong>Contact (WhatsApp):</strong> ${d.contactNumber || ''}</p>
          <p><strong>Menu Details:</strong> ${d.menu || ''}</p>
          <button class='edit-btn' onclick='editProfile()'>Edit Profile</button>
          <button class='delete-btn' onclick='deleteProfile()'>Delete Profile</button>
        `;
      }
      showSection('myProfile');
    }

    function editProfile() {
      const container = document.getElementById('myProfileDetails');
      const stored = JSON.parse(localStorage.getItem('provider') || '{}');
      const d = stored.details || {};
      container.innerHTML = `
        <div class='profile-edit-field'>
          <label>Name</label>
          <input type='text' id='editName' value='${d.name || ''}' />
        </div>
        <div class='profile-edit-field'>
          <label>Location</label>
          <input type='text' id='editLocation' value='${d.location || ''}' />
        </div>
        <div class='profile-edit-field'>
          <label>Food Type</label>
          <input type='text' id='editFoodType' value='${d.foodType || ''}' />
        </div>
        <div class='profile-edit-field'>
          <label>Per Tiffin Price (‚Çπ)</label>
          <input type='number' id='editPerTiffin' value='${d.perTiffinPrice || ''}' />
        </div>
        <div class='profile-edit-field'>
          <label>Monthly Price (‚Çπ)</label>
          <input type='number' id='editMonthly' value='${d.monthlyPrice || ''}' />
        </div>
        <div class='profile-edit-field'>
          <label>Open Time</label>
          <input type='text' id='editOpenTime' value='${d.openTime || ''}' />
        </div>
        <div class='profile-edit-field'>
          <label>Contact (WhatsApp)</label>
          <input type='text' id='editContact' value='${d.contactNumber || ''}' />
        </div>
        <div class='profile-edit-field'>
          <label>Menu Details</label>
          <textarea id='editMenu' rows='3'>${d.menu || ''}</textarea>
        </div>
        <button class='edit-btn' onclick='saveProfileEdits()'>Save</button>
        <button class='delete-btn' onclick='deleteProfile()'>Delete Profile</button>
      `;
    }

    function saveProfileEdits() {
      const stored = JSON.parse(localStorage.getItem('provider') || '{}');
      if (!stored.details) stored.details = {};
      stored.details.name            = document.getElementById('editName').value.trim();
      stored.details.location        = document.getElementById('editLocation').value.trim();
      stored.details.foodType        = document.getElementById('editFoodType').value.trim();
      stored.details.perTiffinPrice  = document.getElementById('editPerTiffin').value.trim();
      stored.details.monthlyPrice    = document.getElementById('editMonthly').value.trim();
      stored.details.openTime        = document.getElementById('editOpenTime').value.trim();
      stored.details.contactNumber   = document.getElementById('editContact').value.trim();
      stored.details.menu            = document.getElementById('editMenu').value.trim();

      localStorage.setItem('provider', JSON.stringify(stored));

      const idx = providers.findIndex(p => p.email === stored.email);
      if (idx > -1) {
        providers[idx].details = stored.details;
      }
      localStorage.setItem('providers', JSON.stringify(providers));

      showMyProfile();
    }

    function deleteProfile() {
      if (!confirm('Are you sure you want to delete your profile? This cannot be undone.')) return;
      const stored = JSON.parse(localStorage.getItem('provider') || '{}');
      if (!stored.email) {
        alert('No provider profile to delete.');
        return;
      }
      providers = providers.filter(p => p.email !== stored.email);
      localStorage.setItem('providers', JSON.stringify(providers));
      localStorage.removeItem('provider');
      alert('Your provider profile has been deleted. Logging out...');
      logout();
    }

    /* ---------- SEARCH & PUBLIC PROFILE VIEW ---------- */
    function searchTiffin() {
      const searchInput = document.getElementById('searchInput').value.trim().toLowerCase();
      const foodTypeFilter = document.getElementById('searchFoodType').value.toLowerCase();
      const resultsDiv = document.getElementById('searchResults');
      resultsDiv.innerHTML = '';

      let allProvidersWithDetails = providers.filter(p => p.details && p.details.name);
      let filtered = allProvidersWithDetails.filter(pr => {
        const d = pr.details;
        const nameMatch = d.name.toLowerCase().includes(searchInput);
        const locMatch = d.location.toLowerCase().includes(searchInput);
        return (searchInput ? (nameMatch || locMatch) : true);
      });
      if (foodTypeFilter !== 'all') {
        filtered = filtered.filter(pr => pr.details.foodType === foodTypeFilter);
      }

      if (filtered.length === 0) {
        resultsDiv.innerHTML = `<p>No providers found.</p>`;
      } else {
        filtered.forEach(pr => {
          const data = pr.details;
          const foodSymbol = getFoodSymbol(data.foodType);

          // Only show the first image if images exist
          let firstImage = '';
          if (data.images && data.images.length > 0) {
            firstImage = `<img src='${data.images[0]}' alt='Provider'/>`;
          }
          // Format phone
          const formattedPhone = formatIndianNumber(data.contactNumber);

          // Create a provider card with left image, right info
          const cardDiv = document.createElement('div');
          cardDiv.className = 'provider-card';
          cardDiv.innerHTML = `
            ${firstImage}
            <div class="provider-info">
              <strong>${data.name}</strong><br/>
              <p>${foodSymbol} ${data.foodType || 'N/A'}</p>
              <p>üïí ${data.openTime || 'N/A'}</p>
              <p>üì± ${formattedPhone || 'N/A'}</p>
              <p class="price-line">
                Per Tiffin: ‚Çπ${data.perTiffinPrice || 'N/A'} 
                &nbsp;/&nbsp; 
                Monthly: ‚Çπ${data.monthlyPrice || 'N/A'}
              </p>
            </div>
          `;
          cardDiv.onclick = () => viewProviderProfile(data);
          resultsDiv.appendChild(cardDiv);
        });
      }
    }

    function viewProviderProfile(data) {
      currentPublicProfile = data;
      const foodSymbol = getFoodSymbol(data.foodType);
      const formattedPhone = formatIndianNumber(data.contactNumber);

      let weeklyMenuHTML = '<ul style="margin-top:8px;">';
      for (const day in data.weeklyMenu) {
        const dayData = data.weeklyMenu[day];
        weeklyMenuHTML += `<li style="margin:5px 0;"><strong>${capitalize(day)}:</strong> ${dayData.text || ''}`;
        if (dayData.image) {
          weeklyMenuHTML += `<br/><img src='${dayData.image}' style='max-width:80px; border-radius:5px; margin-top:5px;'/>`;
        }
        weeklyMenuHTML += `</li>`;
      }
      weeklyMenuHTML += '</ul>';

      const profileHTML = `
        <p style="margin:8px 0;"><strong>Name:</strong> ${data.name}</p>
        <p style="margin:8px 0;"><strong>Food Type:</strong> ${foodSymbol} ${data.foodType}</p>
        <p style="margin:8px 0;"><strong>Per Tiffin Price:</strong> ‚Çπ${data.perTiffinPrice || 'N/A'}</p>
        <p style="margin:8px 0;"><strong>Monthly Price:</strong> ‚Çπ${data.monthlyPrice || 'N/A'}</p>
        <p style="margin:8px 0;"><strong>Menu Details:</strong> ${data.menu}</p>
        <p style="margin:8px 0;"><strong>Service Open Time:</strong> ${data.openTime}</p>
        <p style="margin:8px 0;">
          <strong>Contact:</strong> 
          üì± ${formattedPhone}
        </p>
        <p style="margin:8px 0;"><strong>Weekly Menu:</strong></p>
        ${weeklyMenuHTML}
        <div class='profile-actions'>
          <button class='directions-btn' onclick='getDirections()'>üó∫Ô∏è Get Directions</button>
          <button class='whatsapp-btn' onclick='chatOnWhatsApp("${formattedPhone}")'>üí¨ Chat on WhatsApp</button>
        </div>
      `;
      document.getElementById('profileDetails').innerHTML = profileHTML;
      showSection('providerProfile');
    }

    function getDirections() {
      if (currentPublicProfile && currentPublicProfile.location) {
        const destination = encodeURIComponent(currentPublicProfile.location);
        window.open(`https://www.google.com/maps/dir/?api=1&destination=${destination}`, '_blank');
      } else {
        alert('Provider location is not available.');
      }
    }

    function chatOnWhatsApp(phone) {
      if (!phone) {
        alert('No WhatsApp number available.');
        return;
      }
      let sanitized = phone.replace(/[^\d+]/g, '');
      if (!sanitized.startsWith('+91')) {
        if (sanitized.startsWith('91')) sanitized = '+' + sanitized;
        else sanitized = '+91' + sanitized;
      }
      const finalNumber = sanitized.replace('+','');
      if (!finalNumber) {
        alert('Invalid phone number for WhatsApp.');
        return;
      }
      window.open(`https://wa.me/${finalNumber}`, '_blank');
    }

    function backToHome() {
      showSection('home');
    }

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    /* ---------- FORGOT PASSWORD (OTP) LOGIC ---------- */
    function openForgotModal(userType) {
      forgotUserType = userType; 
      forgotEmail = '';
      forgotOTP = '';
      document.getElementById('forgotStatus').textContent = '';
      document.getElementById('forgotStep1').style.display = 'block';
      document.getElementById('forgotStep2').style.display = 'none';
      document.getElementById('forgotEmail').value = '';
      document.getElementById('otpInput').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('showOTP').textContent = ''; 
      document.getElementById('forgotModal').style.display = 'flex';
    }
    function closeForgotModal() {
      document.getElementById('forgotModal').style.display = 'none';
    }
    function sendOTP() {
      const forgotStatus = document.getElementById('forgotStatus');
      const email = document.getElementById('forgotEmail').value.trim().toLowerCase();
      if (!email) {
        forgotStatus.textContent = 'Please enter an email.';
        return;
      }
      if (forgotUserType === 'visitor') {
        const found = visitors.find(v => v.email === email);
        if (!found) {
          forgotStatus.textContent = 'Email not found.';
          return;
        }
      } else {
        const found = providers.find(p => p.email === email);
        if (!found) {
          forgotStatus.textContent = 'Email not found.';
          return;
        }
      }
      forgotEmail = email;
      forgotOTP = Math.floor(100000 + Math.random() * 900000).toString();
      document.getElementById('showOTP').textContent = `Your OTP is: ${forgotOTP}`;
      document.getElementById('forgotStep1').style.display = 'none';
      document.getElementById('forgotStep2').style.display = 'block';
      forgotStatus.textContent = '';
    }
    function verifyOTP() {
      const forgotStatus = document.getElementById('forgotStatus');
      const code = document.getElementById('otpInput').value.trim();
      const newPass = document.getElementById('newPassword').value;
      if (!code || !newPass) {
        forgotStatus.textContent = 'Please enter OTP and new password.';
        return;
      }
      if (code !== forgotOTP) {
        forgotStatus.textContent = 'Invalid OTP.';
        return;
      }
      if (forgotUserType === 'visitor') {
        const idx = visitors.findIndex(v => v.email === forgotEmail);
        if (idx > -1) {
          visitors[idx].password = newPass;
          localStorage.setItem('visitors', JSON.stringify(visitors));
          forgotStatus.style.color = 'green';
          forgotStatus.textContent = `Password updated for ${forgotEmail}. You can now log in.`;
        } else {
          forgotStatus.textContent = 'User not found?';
        }
      } else {
        const idx = providers.findIndex(p => p.email === forgotEmail);
        if (idx > -1) {
          providers[idx].password = newPass;
          localStorage.setItem('providers', JSON.stringify(providers));
          forgotStatus.style.color = 'green';
          forgotStatus.textContent = `Password updated for ${forgotEmail}. You can now log in.`;
        } else {
          forgotStatus.textContent = 'Provider not found?';
        }
      }
      forgotOTP = '';
      forgotEmail = '';
      document.getElementById('otpInput').value = '';
      document.getElementById('newPassword').value = '';
    }
  </script>
</body>
</html>
