//html program
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tiffin Service Finder</title>
  <!-- Modern UI Font: Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    /* ---------- GLOBAL STYLES ---------- */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      background: #f5f5f5;
      color: #333;
    }
    a {
      cursor: pointer;
    }
    /* ---------- HEADER (Hidden Until Login) ---------- */
    header {
      display: none; /* hidden until login */
      background: #333;
      color: #fff;
      text-align: center;
      padding: 30px 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      border-radius: 0 0 15px 15px;
      position: relative;
    }
    header h1 {
      margin: 0;
      font-weight: 600;
      font-size: 24px;
    }
    header nav {
      margin-top: 15px;
    }
    header nav a {
      text-decoration: none;
      color: #fff;
      font-weight: 500;
      margin: 0 12px;
      padding: 6px 12px;
      border-radius: 6px;
      transition: all 0.3s;
    }
    header nav a:hover {
      background: #fff;
      color: #333;
    }

    /* ---------- SECTIONS ---------- */
    section {
      width: 90%;
      max-width: 900px;
      margin: 30px auto;
      background: #fff;
      border-radius: 12px;
      padding: 30px 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: none; /* hidden by default */
      position: relative;
    }
    section.active {
      display: block;
    }
    section h2 {
      margin-top: 0;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 600;
      color: #333;
    }

    /* ---------- LOGIN SECTION ---------- */
    #login {
      min-height: 80vh;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      border-radius: 12px;
      background: #fff;
    }
    #login::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: url('https://images.unsplash.com/photo-1604908174899-9a3632f74d74?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=60') no-repeat center center;
      background-size: cover;
      filter: blur(4px);
      z-index: -1;
    }
    #loginCard {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(5px);
      border-radius: 10px;
      padding: 30px 20px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      position: relative;
      z-index: 2;
    }
    #loginCard h2 {
      margin-bottom: 15px;
      text-align: center;
      color: #333;
    }
    .login-tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      gap: 10px;
    }
    .login-tab {
      padding: 8px 16px;
      cursor: pointer;
      border: 2px solid #333;
      color: #333;
      border-radius: 20px;
      font-weight: 500;
      transition: all 0.3s;
    }
    .login-tab.active {
      background: #333;
      color: #fff;
    }

    /* ---------- INPUTS & BUTTONS ---------- */
    input, select, textarea, button {
      width: 90%;
      margin: 10px auto;
      display: block;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      transition: all 0.3s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #333;
      box-shadow: 0 0 4px rgba(0,0,0,0.2);
    }
    button {
      background: #333;
      color: #fff;
      font-weight: 500;
      cursor: pointer;
      border: none;
    }
    button:hover {
      background: #555;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }

    /* ---------- FORGOT PASSWORD MODAL (OTP) ---------- */
    #forgotModal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none; /* hidden by default */
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    #forgotModal .modal-content {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    #forgotModal h3 {
      margin: 0 0 10px;
      color: #333;
      font-weight: 600;
    }

    /* ---------- PROVIDER CARD ---------- */
    .provider-card {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      margin: 15px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.07);
      transition: transform 0.3s, box-shadow 0.3s;
      text-align: center;
      cursor: pointer;
    }
    .provider-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .provider-card img {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 50%;
      border: 2px solid #333;
      margin-bottom: 10px;
    }

    /* ---------- PROVIDER PROFILE ---------- */
    .profile-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
      align-items: center;
    }
    .whatsapp-btn {
      background: #25D366; /* WhatsApp green */
      border: none;
      color: #fff;
      font-weight: 500;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .whatsapp-btn:hover {
      background: #20b957;
    }
    .directions-btn {
      background: #4285F4;
      border: none;
      color: #fff;
      font-weight: 500;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .directions-btn:hover {
      background: #357AE8;
    }

    /* ---------- WEEKLY MENU ---------- */
    .daily-menu {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 12px;
      margin: 8px auto;
    }
    .daily-menu label {
      font-weight: 500;
      margin-bottom: 6px;
      display: block;
    }

    /* ---------- MY PROFILE SECTION (Provider's Own Profile) ---------- */
    #myProfileDetails p {
      margin: 6px 0;
      line-height: 1.4;
    }
    #myProfileDetails p strong {
      color: #333;
    }
    .edit-btn {
      background: #555;
      color: #fff;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      margin-top: 10px;
      cursor: pointer;
    }
    .edit-btn:hover {
      background: #777;
    }
    .profile-edit-field {
      display: block;
      margin: 5px 0;
    }
    .delete-btn {
      background: #c00;
      color: #fff;
      margin-top: 15px;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      border: none;
    }
    .delete-btn:hover {
      background: #900;
    }
  </style>
</head>
<body>
  <!-- FORGOT PASSWORD MODAL -->
  <div id="forgotModal">
    <div class="modal-content">
      <h3>Forgot Password (OTP)</h3>
      <!-- Step 1: Enter Email -->
      <div id="forgotStep1">
        <input type="email" id="forgotEmail" placeholder="Enter your email" />
        <button onclick="sendOTP()">Send OTP</button>
      </div>
      <!-- Step 2: Enter OTP & New Password -->
      <div id="forgotStep2" style="display:none;">
        <!-- Show the OTP here for demonstration -->
        <p><strong id="showOTP" style="color:green;"></strong></p>

        <input type="text" id="otpInput" placeholder="Enter OTP" />
        <input type="password" id="newPassword" placeholder="New password" style="margin-top:10px;" />
        <button onclick="verifyOTP()" style="margin-top:15px;">Reset Password</button>
      </div>
      <button onclick="closeForgotModal()" style="margin-top:15px; background:#ccc; color:#333;">Cancel</button>
      <div id="forgotStatus" style="margin-top:10px; color:#e00;"></div>
    </div>
  </div>

  <!-- HEADER (hidden until login) -->
  <header id="mainHeader">
    <h1>Tiffin Service Finder</h1>
    <nav>
      <a onclick="showSection('home')">Home</a>
      <a id="providerLink" onclick="showSection('dashboard')">Dashboard</a>
      <a id="myProfileLink" onclick="showMyProfile()">My Profile</a>
      <a onclick="logout()">Logout</a>
    </nav>
  </header>

  <!-- LOGIN / SIGNUP (Default) -->
  <section id="login" class="active">
    <div id="loginCard">
      <h2>Login / Signup</h2>
      <div class="login-tabs">
        <div id="visitorTab" class="login-tab active" onclick="showVisitorLogin()">Visitor</div>
        <div id="providerTab" class="login-tab" onclick="showProviderLogin()">Provider</div>
      </div>

      <!-- Visitor Login Form -->
      <div id="visitorLogin">
        <input type="email" id="visitorEmail" placeholder="Visitor Email"/>
        <input type="password" id="visitorPassword" placeholder="Password"/>
        <div style="text-align:right; margin:0 20px;">
          <a onclick="openForgotModal('visitor')" style="font-size:13px; color:#333;">Forgot Password?</a>
        </div>
        <button onclick="loginVisitor()">Login as Visitor</button>
        <button onclick="signupVisitor()">Signup as Visitor</button>
        <div id="visitorStatus" style="text-align:center; margin-top:10px;"></div>
      </div>

      <!-- Provider Login Form (hidden) -->
      <div id="providerLogin" style="display:none;">
        <input type="email" id="providerEmail" placeholder="Provider Email"/>
        <input type="password" id="providerPassword" placeholder="Password"/>
        <div style="text-align:right; margin:0 20px;">
          <a onclick="openForgotModal('provider')" style="font-size:13px; color:#333;">Forgot Password?</a>
        </div>
        <button onclick="loginProvider()">Login as Provider</button>
        <button onclick="signupProvider()">Signup as Provider</button>
        <div id="providerLoginStatus" style="text-align:center; margin-top:10px;"></div>
      </div>
    </div>
  </section>

  <!-- HOME PAGE (for Visitors) -->
  <section id="home">
    <h2>Find Your Tiffin Service</h2>
    <input type="text" id="searchInput" placeholder="Search by name or location"/>
    <select id="searchFoodType">
      <option value="all">All</option>
      <option value="veg">Vegetarian</option>
      <option value="non-veg">Non-Vegetarian</option>
      <option value="vegan">Vegan</option>
      <option value="jain">Jain</option>
    </select>
    <button onclick="searchTiffin()">Search</button>
    <div id="searchResults"></div>
  </section>

  <!-- PROVIDER DASHBOARD -->
  <section id="dashboard">
    <h2>Provider Dashboard</h2>
    <p style="text-align:center; margin-bottom:10px;">
      Add or update your Tiffin Service details.
    </p>
    <input type="text" id="providerName" placeholder="Your Name"/>
    <input type="text" id="providerLocation" placeholder="Location"/>
    <input type="text" id="providerFoodType" placeholder="Food Type (e.g., Veg, Non-Veg)"/>
    
    <!-- Replaced single price with two new fields -->
    <input type="number" id="perTiffinPrice" placeholder="Per Tiffin Price (in ₹)" />
    <input type="number" id="monthlyPrice" placeholder="Monthly Price (in ₹)" />

    <textarea id="providerMenu" placeholder="Menu Details" rows="4"></textarea>
    <input type="text" id="openTime" placeholder="Service Open Time (e.g., 8 AM - 8 PM)"/>
    <input type="text" id="contactNumber" placeholder="WhatsApp Number (+91)" />

    <h3 style="margin-top:20px;">Weekly Menu</h3>
    <div class="daily-menu">
      <label>Monday Menu</label>
      <input type="text" id="menuMonday" placeholder="Monday menu"/>
      <input type="file" id="imageMonday" accept="image/*"/>
    </div>
    <div class="daily-menu">
      <label>Tuesday Menu</label>
      <input type="text" id="menuTuesday" placeholder="Tuesday menu"/>
      <input type="file" id="imageTuesday" accept="image/*"/>
    </div>
    <div class="daily-menu">
      <label>Wednesday Menu</label>
      <input type="text" id="menuWednesday" placeholder="Wednesday menu"/>
      <input type="file" id="imageWednesday" accept="image/*"/>
    </div>
    <div class="daily-menu">
      <label>Thursday Menu</label>
      <input type="text" id="menuThursday" placeholder="Thursday menu"/>
      <input type="file" id="imageThursday" accept="image/*"/>
    </div>
    <div class="daily-menu">
      <label>Friday Menu</label>
      <input type="text" id="menuFriday" placeholder="Friday menu"/>
      <input type="file" id="imageFriday" accept="image/*"/>
    </div>
    <div class="daily-menu">
      <label>Saturday Menu</label>
      <input type="text" id="menuSaturday" placeholder="Saturday menu"/>
      <input type="file" id="imageSaturday" accept="image/*"/>
    </div>
    <div class="daily-menu">
      <label>Sunday Menu</label>
      <input type="text" id="menuSunday" placeholder="Sunday menu"/>
      <input type="file" id="imageSunday" accept="image/*"/>
    </div>

    <h3 style="margin-top:20px;">Upload Dish Images (General)</h3>
    <input type="file" id="providerImages" accept="image/*" multiple/>
    <button onclick="addService()">Add/Update Service</button>
    <div id="providerStatus" style="text-align:center; margin-top:10px;"></div>
  </section>

  <!-- MY PROFILE (Provider's Own Profile) -->
  <section id="myProfile">
    <h2>My Profile</h2>
    <div id="myProfileDetails"></div>
    <button onclick="backToHome()">Back to Home</button>
  </section>

  <!-- PUBLIC PROVIDER PROFILE (for visitors) -->
  <section id="providerProfile">
    <h2>Provider Profile</h2>
    <div id="profileDetails"></div>
    <button onclick="backToHome()">Back to Search</button>
  </section>

  <script>
    /* ---------- GLOBALS ---------- */
    let visitors = JSON.parse(localStorage.getItem('visitors') || '[]');   
    let providers = JSON.parse(localStorage.getItem('providers') || '[]'); 
    let currentPublicProfile = null; 
    let currentUserType = '';

    // For OTP
    let forgotUserType = ''; 
    let forgotEmail = '';    
    let forgotOTP = '';      

    /* ---------- SHOW/HIDE SECTIONS ---------- */
    function showSection(id) {
      document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function logout() {
      document.getElementById('mainHeader').style.display = 'none';
      showSection('login');
      document.getElementById('login').style.display = 'flex';
    }

    /* ---------- SWITCH LOGIN UI ---------- */
    function showVisitorLogin() {
      document.getElementById('visitorLogin').style.display = 'block';
      document.getElementById('providerLogin').style.display = 'none';
      document.getElementById('visitorTab').classList.add('active');
      document.getElementById('providerTab').classList.remove('active');
    }
    function showProviderLogin() {
      document.getElementById('visitorLogin').style.display = 'none';
      document.getElementById('providerLogin').style.display = 'block';
      document.getElementById('providerTab').classList.add('active');
      document.getElementById('visitorTab').classList.remove('active');
    }

    /* ---------- VISITOR LOGIN/SIGNUP ---------- */
    function signupVisitor() {
      const email = document.getElementById('visitorEmail').value.trim().toLowerCase();
      const password = document.getElementById('visitorPassword').value;
      const statusDiv = document.getElementById('visitorStatus');
      if (!email || !password) {
        statusDiv.innerHTML = `<p style='color:red;'>Please enter both email and password.</p>`;
        return;
      }
      const existing = visitors.find(v => v.email === email);
      if (existing) {
        statusDiv.innerHTML = `<p style='color:red;'>Email already registered.</p>`;
        return;
      }
      visitors.push({ email, password });
      localStorage.setItem('visitors', JSON.stringify(visitors));
      statusDiv.innerHTML = `<p style='color:green;'>Visitor signup successful for ${email}</p>`;
      currentUserType = 'visitor';

      document.getElementById('providerLink').style.display = 'none';
      document.getElementById('myProfileLink').style.display = 'none';
      document.getElementById('mainHeader').style.display = 'block';
      document.getElementById('login').style.display = 'none';
      showSection('home');
    }

    function loginVisitor() {
      const email = document.getElementById('visitorEmail').value.trim().toLowerCase();
      const password = document.getElementById('visitorPassword').value;
      const statusDiv = document.getElementById('visitorStatus');
      if (!email || !password) {
        statusDiv.innerHTML = `<p style='color:red;'>Please enter both email and password.</p>`;
        return;
      }
      const found = visitors.find(v => v.email === email && v.password === password);
      if (found) {
        statusDiv.innerHTML = `<p style='color:green;'>Visitor logged in as ${email}</p>`;
        currentUserType = 'visitor';

        document.getElementById('providerLink').style.display = 'none';
        document.getElementById('myProfileLink').style.display = 'none';
        document.getElementById('mainHeader').style.display = 'block';
        document.getElementById('login').style.display = 'none';
        showSection('home');
      } else {
        statusDiv.innerHTML = `<p style='color:red;'>Invalid credentials.</p>`;
      }
    }

    /* ---------- PROVIDER LOGIN/SIGNUP ---------- */
    function signupProvider() {
      const email = document.getElementById('providerEmail').value.trim().toLowerCase();
      const password = document.getElementById('providerPassword').value;
      const statusDiv = document.getElementById('providerLoginStatus');
      if (!email || !password) {
        statusDiv.innerHTML = `<p style='color:red;'>Please enter both email and password.</p>`;
        return;
      }
      const existing = providers.find(p => p.email === email);
      if (existing) {
        statusDiv.innerHTML = `<p style='color:red;'>Email already registered.</p>`;
        return;
      }
      providers.push({ email, password, details: {} });
      localStorage.setItem('providers', JSON.stringify(providers));
      statusDiv.innerHTML = `<p style='color:green;'>Provider signup successful for ${email}</p>`;
      currentUserType = 'provider';

      document.getElementById('providerLink').style.display = 'inline-block';
      document.getElementById('myProfileLink').style.display = 'inline-block';
      document.getElementById('mainHeader').style.display = 'block';
      document.getElementById('login').style.display = 'none';
      loadProviderDetails(email);
      showSection('dashboard');
    }

    function loginProvider() {
      const email = document.getElementById('providerEmail').value.trim().toLowerCase();
      const password = document.getElementById('providerPassword').value;
      const statusDiv = document.getElementById('providerLoginStatus');
      if (!email || !password) {
        statusDiv.innerHTML = `<p style='color:red;'>Please enter both email and password.</p>`;
        return;
      }
      const found = providers.find(p => p.email === email && p.password === password);
      if (found) {
        statusDiv.innerHTML = `<p style='color:green;'>Provider logged in as ${email}</p>`;
        currentUserType = 'provider';

        document.getElementById('providerLink').style.display = 'inline-block';
        document.getElementById('myProfileLink').style.display = 'inline-block';
        document.getElementById('mainHeader').style.display = 'block';
        document.getElementById('login').style.display = 'none';
        localStorage.setItem('provider', JSON.stringify(found));
        loadProviderDetails(email);
        showSection('dashboard');
      } else {
        statusDiv.innerHTML = `<p style='color:red;'>Invalid credentials.</p>`;
      }
    }

    /* ---------- LOAD PROVIDER DASHBOARD DETAILS ---------- */
    function loadProviderDetails(email) {
      if (!email) {
        const stored = JSON.parse(localStorage.getItem('provider') || '{}');
        if (stored.details) fillDashboard(stored.details);
      } else {
        const found = providers.find(p => p.email === email);
        if (found && found.details) fillDashboard(found.details);
      }
    }

    // Fill the form with existing provider details
    function fillDashboard(d) {
      document.getElementById('providerName').value     = d.name          || '';
      document.getElementById('providerLocation').value = d.location      || '';
      document.getElementById('providerFoodType').value = d.foodType      || '';
      
      // For new price fields:
      document.getElementById('perTiffinPrice').value   = d.perTiffinPrice || '';
      document.getElementById('monthlyPrice').value     = d.monthlyPrice   || '';

      document.getElementById('providerMenu').value     = d.menu          || '';
      document.getElementById('openTime').value         = d.openTime      || '';

      let phone = d.contactNumber || '';
      if (phone && !phone.startsWith('+91')) {
        if (phone.startsWith('91')) {
          phone = '+' + phone;
        } else {
          phone = '+91' + phone;
        }
      }
      d.contactNumber = phone;
      document.getElementById('contactNumber').value = phone;

      if (d.weeklyMenu) {
        document.getElementById('menuMonday').value    = d.weeklyMenu.monday?.text    || '';
        document.getElementById('menuTuesday').value   = d.weeklyMenu.tuesday?.text   || '';
        document.getElementById('menuWednesday').value = d.weeklyMenu.wednesday?.text || '';
        document.getElementById('menuThursday').value  = d.weeklyMenu.thursday?.text  || '';
        document.getElementById('menuFriday').value    = d.weeklyMenu.friday?.text    || '';
        document.getElementById('menuSaturday').value  = d.weeklyMenu.saturday?.text  || '';
        document.getElementById('menuSunday').value    = d.weeklyMenu.sunday?.text    || '';
      }
    }

    // Read single image from input
    async function readSingleImage(elementId) {
      const fileInput = document.getElementById(elementId);
      if (fileInput.files && fileInput.files[0]) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = e => resolve(e.target.result);
          reader.onerror = () => reject('Error reading file');
          reader.readAsDataURL(fileInput.files[0]);
        });
      } else {
        return Promise.resolve('');
      }
    }

    // Add/Update service with new price fields
    async function addService() {
      const name          = document.getElementById('providerName').value.trim();
      const location      = document.getElementById('providerLocation').value.trim();
      const foodType      = document.getElementById('providerFoodType').value.trim().toLowerCase();
      const perTiffin     = document.getElementById('perTiffinPrice').value.trim();
      const monthly       = document.getElementById('monthlyPrice').value.trim();
      const menu          = document.getElementById('providerMenu').value.trim();
      const openTime      = document.getElementById('openTime').value.trim();
      let   contactNumber = document.getElementById('contactNumber').value.trim();
      const statusDiv     = document.getElementById('providerStatus');

      // Ensure +91 for phone
      if (contactNumber && !contactNumber.startsWith('+91')) {
        if (contactNumber.startsWith('91')) {
          contactNumber = '+' + contactNumber;
        } else {
          contactNumber = '+91' + contactNumber;
        }
      }

      // Weekly menu text
      const monText = document.getElementById('menuMonday').value.trim();
      const tueText = document.getElementById('menuTuesday').value.trim();
      const wedText = document.getElementById('menuWednesday').value.trim();
      const thuText = document.getElementById('menuThursday').value.trim();
      const friText = document.getElementById('menuFriday').value.trim();
      const satText = document.getElementById('menuSaturday').value.trim();
      const sunText = document.getElementById('menuSunday').value.trim();

      // Weekly menu images
      const monImg = await readSingleImage('imageMonday');
      const tueImg = await readSingleImage('imageTuesday');
      const wedImg = await readSingleImage('imageWednesday');
      const thuImg = await readSingleImage('imageThursday');
      const friImg = await readSingleImage('imageFriday');
      const satImg = await readSingleImage('imageSaturday');
      const sunImg = await readSingleImage('imageSunday');

      const weeklyMenu = {
        monday:    { text: monText, image: monImg },
        tuesday:   { text: tueText, image: tueImg },
        wednesday: { text: wedText, image: wedImg },
        thursday:  { text: thuText, image: thuImg },
        friday:    { text: friText, image: friImg },
        saturday:  { text: satText, image: satImg },
        sunday:    { text: sunText, image: sunImg }
      };

      // Check required fields
      if (!name || !location || !foodType || !perTiffin || !monthly || !menu || !openTime || !contactNumber) {
        statusDiv.innerHTML = `<p style='color:red;'>Please fill all required fields (including both price fields).</p>`;
        return;
      }

      // Retrieve current provider from localStorage
      const storedProvider = JSON.parse(localStorage.getItem('provider') || '{}');
      storedProvider.details = {
        name,
        location,
        foodType,
        perTiffinPrice: perTiffin,
        monthlyPrice: monthly,
        menu,
        openTime,
        contactNumber,
        weeklyMenu
      };

      // Read general dish images if any
      const imageFiles = document.getElementById('providerImages').files;
      let generalImages = [];
      if (imageFiles.length > 0) {
        generalImages = await Promise.all(
          Array.from(imageFiles).map(file => {
            return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = e => resolve(e.target.result);
              reader.onerror = () => reject('Error reading file');
              reader.readAsDataURL(file);
            });
          })
        );
      }
      storedProvider.details.images = generalImages;

      // Save back to localStorage and the providers array
      localStorage.setItem('provider', JSON.stringify(storedProvider));
      const foundIndex = providers.findIndex(p => p.email === storedProvider.email);
      if (foundIndex > -1) {
        providers[foundIndex].details = storedProvider.details;
      }
      localStorage.setItem('providers', JSON.stringify(providers));

      statusDiv.innerHTML = `<p style='color:green;'>Service for ${name} updated successfully!</p>`;
    }

    /* ---------- MY PROFILE (Provider's Own) ---------- */
    function showMyProfile() {
      const stored = JSON.parse(localStorage.getItem('provider') || '{}');
      const container = document.getElementById('myProfileDetails');
      container.innerHTML = '';
      if (!stored.details) {
        container.innerHTML = `<p>No profile data found. Please update your details in the Dashboard.</p>`;
      } else {
        const d = stored.details;
        container.innerHTML = `
          <p><strong>Name:</strong> ${d.name || ''}</p>
          <p><strong>Location:</strong> ${d.location || ''}</p>
          <p><strong>Food Type:</strong> ${d.foodType || ''}</p>
          <p><strong>Per Tiffin Price:</strong> ₹${d.perTiffinPrice || ''}</p>
          <p><strong>Monthly Price:</strong> ₹${d.monthlyPrice || ''}</p>
          <p><strong>Open Time:</strong> ${d.openTime || ''}</p>
          <p><strong>Contact (WhatsApp):</strong> ${d.contactNumber || ''}</p>
          <p><strong>Menu Details:</strong> ${d.menu || ''}</p>
          <button class='edit-btn' onclick='editProfile()'>Edit Profile</button>
          <button class='delete-btn' onclick='deleteProfile()'>Delete Profile</button>
        `;
      }
      showSection('myProfile');
    }

    function editProfile() {
      const container = document.getElementById('myProfileDetails');
      const stored = JSON.parse(localStorage.getItem('provider') || '{}');
      const d = stored.details || {};
      container.innerHTML = `
        <div class='profile-edit-field'>
          <label>Name</label>
          <input type='text' id='editName' value='${d.name || ''}' />
        </div>
        <div class='profile-edit-field'>
          <label>Location</label>
          <input type='text' id='editLocation' value='${d.location || ''}' />
        </div>
        <div class='profile-edit-field'>
          <label>Food Type</label>
          <input type='text' id='editFoodType' value='${d.foodType || ''}' />
        </div>
        <div class='profile-edit-field'>
          <label>Per Tiffin Price (₹)</label>
          <input type='number' id='editPerTiffin' value='${d.perTiffinPrice || ''}' />
        </div>
        <div class='profile-edit-field'>
          <label>Monthly Price (₹)</label>
          <input type='number' id='editMonthly' value='${d.monthlyPrice || ''}' />
        </div>
        <div class='profile-edit-field'>
          <label>Open Time</label>
          <input type='text' id='editOpenTime' value='${d.openTime || ''}' />
        </div>
        <div class='profile-edit-field'>
          <label>Contact (WhatsApp)</label>
          <input type='text' id='editContact' value='${d.contactNumber || ''}' />
        </div>
        <div class='profile-edit-field'>
          <label>Menu Details</label>
          <textarea id='editMenu' rows='3'>${d.menu || ''}</textarea>
        </div>
        <button class='edit-btn' onclick='saveProfileEdits()'>Save</button>
        <button class='delete-btn' onclick='deleteProfile()'>Delete Profile</button>
      `;
    }

    function saveProfileEdits() {
      const stored = JSON.parse(localStorage.getItem('provider') || '{}');
      if (!stored.details) stored.details = {};
      stored.details.name          = document.getElementById('editName').value.trim();
      stored.details.location      = document.getElementById('editLocation').value.trim();
      stored.details.foodType      = document.getElementById('editFoodType').value.trim();
      stored.details.perTiffinPrice= document.getElementById('editPerTiffin').value.trim();
      stored.details.monthlyPrice  = document.getElementById('editMonthly').value.trim();
      stored.details.openTime      = document.getElementById('editOpenTime').value.trim();
      stored.details.contactNumber = document.getElementById('editContact').value.trim();
      stored.details.menu          = document.getElementById('editMenu').value.trim();

      localStorage.setItem('provider', JSON.stringify(stored));

      const idx = providers.findIndex(p => p.email === stored.email);
      if (idx > -1) {
        providers[idx].details = stored.details;
      }
      localStorage.setItem('providers', JSON.stringify(providers));

      showMyProfile(); // re-render
    }

    function deleteProfile() {
      if (!confirm('Are you sure you want to delete your profile? This cannot be undone.')) return;
      const stored = JSON.parse(localStorage.getItem('provider') || '{}');
      if (!stored.email) {
        alert('No provider profile to delete.');
        return;
      }
      // remove from providers array
      providers = providers.filter(p => p.email !== stored.email);
      localStorage.setItem('providers', JSON.stringify(providers));
      // remove from localStorage
      localStorage.removeItem('provider');
      alert('Your provider profile has been deleted. Logging out...');
      logout();
    }

    /* ---------- SEARCH & PUBLIC PROFILE VIEW ---------- */
    function searchTiffin() {
      const searchInput = document.getElementById('searchInput').value.trim().toLowerCase();
      const foodTypeFilter = document.getElementById('searchFoodType').value.toLowerCase();
      const resultsDiv = document.getElementById('searchResults');
      resultsDiv.innerHTML = '';

      let allProvidersWithDetails = providers.filter(p => p.details && p.details.name);
      let filtered = allProvidersWithDetails.filter(pr => {
        const d = pr.details;
        const nameMatch = d.name.toLowerCase().includes(searchInput);
        const locMatch = d.location.toLowerCase().includes(searchInput);
        return (searchInput ? (nameMatch || locMatch) : true);
      });
      if (foodTypeFilter !== 'all') {
        filtered = filtered.filter(pr => pr.details.foodType === foodTypeFilter);
      }

      if (filtered.length === 0) {
        resultsDiv.innerHTML = `<p>No providers found.</p>`;
      } else {
        filtered.forEach(pr => {
          const data = pr.details;
          // Only show the first image if images exist:
          let firstImage = '';
          if (data.images && data.images.length > 0) {
            firstImage = `<img src='${data.images[0]}' alt='Provider'/>`;
          }
          const div = document.createElement('div');
          div.className = 'provider-card';
          div.innerHTML = `
            ${firstImage}
            <strong>${data.name}</strong><br/>
            Food Type: ${data.foodType || 'N/A'}<br/>
            Open Time: ${data.openTime || 'N/A'}<br/>
            Contact: ${data.contactNumber || 'N/A'}<br/>
            <!-- Show new price fields in search results too -->
            Per Tiffin: ₹${data.perTiffinPrice || 'N/A'} / Monthly: ₹${data.monthlyPrice || 'N/A'}
          `;
          div.onclick = () => viewProviderProfile(data);
          resultsDiv.appendChild(div);
        });
      }
    }

    function viewProviderProfile(data) {
      currentPublicProfile = data;
      let weeklyMenuHTML = '<ul>';
      for (const day in data.weeklyMenu) {
        const dayData = data.weeklyMenu[day];
        weeklyMenuHTML += `<li><strong>${capitalize(day)}:</strong> ${dayData.text || ''}`;
        if (dayData.image) {
          weeklyMenuHTML += `<br/><img src='${dayData.image}' style='max-width:80px; border-radius:5px; margin-top:5px;'/>`;
        }
        weeklyMenuHTML += `</li>`;
      }
      weeklyMenuHTML += '</ul>';

      const profileHTML = `
        <p><strong>Name:</strong> ${data.name}</p>
        <p><strong>Location:</strong> ${data.location}</p>
        <p><strong>Food Type:</strong> ${data.foodType}</p>
        <p><strong>Per Tiffin Price:</strong> ₹${data.perTiffinPrice || 'N/A'}</p>
        <p><strong>Monthly Price:</strong> ₹${data.monthlyPrice || 'N/A'}</p>
        <p><strong>Menu Details:</strong> ${data.menu}</p>
        <p><strong>Service Open Time:</strong> ${data.openTime}</p>
        <p><strong>Contact Number (WhatsApp):</strong> ${data.contactNumber}</p>
        <p><strong>Weekly Menu:</strong></p>
        ${weeklyMenuHTML}
        <div class='profile-actions'>
          <button class='directions-btn' onclick='getDirections()'>Get Directions</button>
          <button class='whatsapp-btn' onclick='chatOnWhatsApp(\"${data.contactNumber}\")'>Chat on WhatsApp</button>
        </div>
      `;
      document.getElementById('profileDetails').innerHTML = profileHTML;

      showSection('providerProfile');
    }

    function getDirections() {
      if (currentPublicProfile && currentPublicProfile.location) {
        const destination = encodeURIComponent(currentPublicProfile.location);
        window.open(`https://www.google.com/maps/dir/?api=1&destination=${destination}`, '_blank');
      } else {
        alert('Provider location is not available.');
      }
    }

    // Prepend +91 if not present
    function chatOnWhatsApp(phone) {
      if (!phone) {
        alert('No WhatsApp number available.');
        return;
      }
      let sanitized = phone.replace(/[^\d+]/g, ''); // keep + sign, digits
      if (!sanitized.startsWith('+91')) {
        if (sanitized.startsWith('91')) {
          sanitized = '+' + sanitized; 
        } else {
          sanitized = '+91' + sanitized;
        }
      }
      if (!sanitized) {
        alert('Invalid phone number for WhatsApp.');
        return;
      }
      window.open(`https://wa.me/${sanitized.replace('+','')}`, '_blank');
    }

    function backToHome() {
      showSection('home');
    }

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    /* ---------- FORGOT PASSWORD (OTP) LOGIC ---------- */
    const forgotModal = document.getElementById('forgotModal');
    const forgotStatus = document.getElementById('forgotStatus');

    function openForgotModal(userType) {
      forgotUserType = userType; // 'visitor' or 'provider'
      forgotEmail = '';
      forgotOTP = '';
      forgotStatus.textContent = '';
      document.getElementById('forgotStep1').style.display = 'block';
      document.getElementById('forgotStep2').style.display = 'none';
      document.getElementById('forgotEmail').value = '';
      document.getElementById('otpInput').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('showOTP').textContent = ''; // Clear displayed OTP
      forgotModal.style.display = 'flex';
    }

    function closeForgotModal() {
      forgotModal.style.display = 'none';
    }

    function sendOTP() {
      const email = document.getElementById('forgotEmail').value.trim().toLowerCase();
      if (!email) {
        forgotStatus.textContent = 'Please enter an email.';
        return;
      }
      if (forgotUserType === 'visitor') {
        const found = visitors.find(v => v.email === email);
        if (!found) {
          forgotStatus.textContent = 'Email not found.';
          return;
        }
      } else {
        const found = providers.find(p => p.email === email);
        if (!found) {
          forgotStatus.textContent = 'Email not found.';
          return;
        }
      }
      // Generate a random 6-digit OTP
      forgotEmail = email;
      forgotOTP = Math.floor(100000 + Math.random() * 900000).toString();

      // Display the OTP on the website for demonstration
      document.getElementById('showOTP').textContent = `Your OTP is: ${forgotOTP}`;

      // Switch to step2
      document.getElementById('forgotStep1').style.display = 'none';
      document.getElementById('forgotStep2').style.display = 'block';

      forgotStatus.textContent = '';
    }

    function verifyOTP() {
      const code = document.getElementById('otpInput').value.trim();
      const newPass = document.getElementById('newPassword').value;
      if (!code || !newPass) {
        forgotStatus.textContent = 'Please enter OTP and new password.';
        return;
      }
      if (code !== forgotOTP) {
        forgotStatus.textContent = 'Invalid OTP.';
        return;
      }
      // OTP matches, reset password in localStorage
      if (forgotUserType === 'visitor') {
        const idx = visitors.findIndex(v => v.email === forgotEmail);
        if (idx > -1) {
          visitors[idx].password = newPass;
          localStorage.setItem('visitors', JSON.stringify(visitors));
          forgotStatus.style.color = 'green';
          forgotStatus.textContent = `Password updated for ${forgotEmail}. You can now log in.`;
        } else {
          forgotStatus.textContent = 'User not found?';
        }
      } else {
        const idx = providers.findIndex(p => p.email === forgotEmail);
        if (idx > -1) {
          providers[idx].password = newPass;
          localStorage.setItem('providers', JSON.stringify(providers));
          forgotStatus.style.color = 'green';
          forgotStatus.textContent = `Password updated for ${forgotEmail}. You can now log in.`;
        } else {
          forgotStatus.textContent = 'Provider not found?';
        }
      }
      // Clear everything
      forgotOTP = '';
      forgotEmail = '';
      document.getElementById('otpInput').value = '';
      document.getElementById('newPassword').value = '';
    }
  </script>
</body>
</html>
